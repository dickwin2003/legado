# 书源显示问题修复总结

## 问题描述
用户反馈在发现界面无法看到书源，尽管 `bookSources.json` 文件中包含数据，界面仍显示"没有发现书源"。

## 问题分析
经过详细的代码分析，发现问题主要在以下几个方面：

1. **查询条件过于严格**：`BookSourceDao.flowExplore()` 方法的查询条件要求同时满足 `enabledExplore = 1` 和 `hasExploreUrl = 1`，这导致很多有效的书源被过滤掉。

2. **数据加载机制**：版本升级时的数据加载逻辑可能没有正确加载默认书源到数据库。

3. **界面显示逻辑**：需要确保书源能像RSS源一样正常显示和点击。

## 修复方案

### 1. 修改BookSourceDao.flowExplore()方法

**文件位置**: `/app/src/main/java/io/legado/app/data/dao/BookSourceDao.kt`

**修改内容**: 第89-94行
```kotlin
/**
 * 获取所有启用的书源用于发现界面显示
 * 显示所有启用的书源，不限制是否有探索URL
 */
@Query(
    """select * from book_sources_part 
    where enabled = 1 
    order by customOrder asc"""
)
fun flowExplore(): Flow<List<BookSourcePart>>
```

**修改原因**: 
- 原始查询条件 `enabledExplore = 1 and hasExploreUrl = 1` 过于严格
- 修改为只检查 `enabled = 1`，让所有启用的书源都能显示
- 即使没有探索URL的书源也可以点击打开其主网站

### 2. 增强默认数据加载机制

**文件位置**: `/app/src/main/java/io/legado/app/help/DefaultData.kt`

**新增内容**: 第55-65行
```kotlin
/**
 * 确保默认书源存在
 * 如果数据库为空，强制加载默认书源
 */
private suspend fun ensureDefaultBookSourcesExist() {
    val existingCount = appDb.bookSourceDao.allCount()
    if (existingCount == 0) {
        // 数据库为空，加载默认书源
        importDefaultBookSources()
    }
}
```

**修改内容**: 第29-53行，在`upVersion()`方法中添加
```kotlin
// 强制检查并确保默认书源存在
ensureDefaultBookSourcesExist()
```

**修改原因**:
- 提供了一个后备机制，确保即使版本检查逻辑有问题，也能保证默认书源被加载
- 当数据库完全为空时，强制加载 `bookSources.json` 中的数据

### 3. 完善ExploreAdapter显示逻辑

**文件位置**: `/app/src/main/java/io/legado/app/ui/main/explore/ExploreAdapter.kt`

**修改内容**: 第46-63行，完善书源显示逻辑
```kotlin
binding.apply {
    tvName.text = item.bookSourceName
    // 参考RSS适配器，使用Glide加载书源图标
    try {
        val options = com.bumptech.glide.request.RequestOptions()
            .set(io.legado.app.help.glide.OkHttpModelLoader.sourceOriginOption, item.bookSourceUrl)
        io.legado.app.help.glide.ImageLoader.load(context, item.bookSourceUrl + "/favicon.ico")
            .apply(options)
            .centerCrop()
            .placeholder(R.drawable.image_legado)
            .error(R.drawable.image_legado)
            .into(ivIcon)
    } catch (e: Exception) {
        // 如果加载失败，使用默认图标
        ivIcon.setImageResource(R.drawable.image_legado)
    }
}
```

### 4. 增强ExploreFragment点击处理

**文件位置**: `/app/src/main/java/io/legado/app/ui/main/explore/ExploreFragment.kt`

**新增内容**: 第293-321行，新增 `openBookSource` 方法
```kotlin
override fun openBookSource(bookSource: BookSourcePart) {
    AppLog.put("ExploreFragment - openBookSource被调用: ${bookSource.bookSourceName}")
    
    // 获取完整的BookSource对象来检查发现规则
    val fullBookSource = bookSource.getBookSource()
    if (fullBookSource != null && !fullBookSource.exploreUrl.isNullOrBlank()) {
        // 获取第一个发现分类
        viewLifecycleOwner.lifecycleScope.launch {
            try {
                val exploreKinds = fullBookSource.exploreKinds()
                if (exploreKinds.isNotEmpty()) {
                    val firstKind = exploreKinds.first()
                    if (!firstKind.url.isNullOrBlank()) {
                        openExplore(bookSource.bookSourceUrl, firstKind.title, firstKind.url)
                        return@launch
                    }
                }
            } catch (e: Exception) {
                AppLog.put("获取发现分类失败", e)
            }
            
            // 如果没有发现分类或获取失败，打开书源网站
            openWebsite(bookSource.bookSourceUrl)
        }
    } else {
        // 没有发现规则，直接打开书源网站
        openWebsite(bookSource.bookSourceUrl)
    }
}
```

## 修复效果

经过以上修复，书源现在应该能够：

1. **正常显示**: 所有启用的书源都会在发现界面显示，不再受探索URL限制
2. **正确加载**: 通过后备机制确保默认书源被正确加载到数据库
3. **可以点击**: 点击书源会智能选择打开方式：
   - 如果有发现规则，打开第一个发现分类
   - 如果没有发现规则，打开书源主网站
4. **类似RSS**: 显示和交互逻辑与RSS源保持一致

## 数据流程

1. **应用启动** → `App.onCreate()` → `DefaultData.upVersion()`
2. **版本检查** → 如果需要更新 → `importDefaultBookSources()`
3. **后备检查** → `ensureDefaultBookSourcesExist()` → 如果数据库为空 → 强制加载
4. **界面显示** → `ExploreFragment.upExploreData()` → `BookSourceDao.flowExplore()`
5. **用户点击** → `ExploreAdapter.registerListener()` → `ExploreFragment.openBookSource()`

## 验证方法

要验证修复是否生效，可以：

1. 清除应用数据
2. 重新安装应用
3. 检查发现界面是否显示书源
4. 点击书源测试是否能正常打开

由于网络问题无法编译APK，但代码修改已经完成，理论上应该能解决书源显示问题。